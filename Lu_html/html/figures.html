<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>图表</title>
    <script src="d3/d3.min.js" type="text/javascript"></script>
    <script>
        // add a zero in front of numbers<10
        function checkTime(i)
        {
            if (i<10)
            {i="0" + i}
            return i
        }
        //转换时间间隔
        Num2Str = function(num){
            var hour=Math.floor(num/4);
            var minute=(num%4)*15;
            return checkTime(hour)+":"+checkTime(minute);
        };
    </script>
</head>
<body>
<h1>Demo "Hello World"</h1>
<div id="hello">
<p>Hello world</p>
<p>Hello world</p>
<p>Hello world</p>
</div>
<script>
    var dataset=["cat","dog","bird"];
    var p=d3.select("body").select("#hello").selectAll("p");
    p.data(dataset)
            .text(function(d,i){
                return i+d;
            });
</script>
<h1>柱状图</h1>
<script>
    var height=100;
    var width =500;
    var svg=d3.select("body")
            .append("svg")
            .attr("height",height)
            .attr("width",width);
    var dataset= [100,200,300,400,500];
    var rectHeight=20;
    svg.selectAll("rect")
            .data(dataset)
            .enter()
            .append("rect")
            .attr("x",20)
            .attr("y",function(d,i){
                return i*rectHeight;
            })
            .attr("width",function(d){
                return d;
            })
            .attr("height",rectHeight-2)
            .attr("fill","steelblue");
</script>
<h1>预约图</h1>
<style>
    .axis path,
    .axis line{
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;
    }

    .axis text {
        font-family: sans-serif;
        font-size: 11px;
    }
</style>
<script>
//    str='[{"pid":"pid1","from":1,"to":2},{"pid":"pid1","from":2,"to":3},{"pid":"pid2","from":1,"to":2}]';
//    var str= '[{"pid":"pid1","from":1,"to":2},{"pid":"pid1","from":33,"to":40},{"pid":"pid2","from":22,"to":43},{"pid":"pid2","from":44,"to":60},{"pid":"pid3","from":80,"to":96}]';
    parseJson = function(str){
        var result=[];
        var dataSet=[];
        var lotMap=[];
        var obj_list=JSON.parse(str);
        var map = new Array();
        if(obj_list instanceof Array) {
            var max_id=0;
            for(var i in obj_list){
                var item=obj_list[i];
                if(map[item.pid]==undefined){
                    max_id++;
                    map[item.pid]=max_id;
                    var set_item=[max_id,item.from,item.to];
                    dataSet.push(set_item);
                    lotMap.push(item.pid);
                }
                else{
                    var set_item=[map[item.pid],item.from,item.to];
                    dataSet.push(set_item);
                }
            }
            result.push(dataSet);
            result.push(lotMap)
            return result;
        }
        else return undefined;
    };
</script>
<script>
    var height=200;
    var width =1000;
    var svg=d3.select("body")
            .append("svg")
            .attr("height",height)
            .attr("width",width);
    var str='[{"pid":"pid1","from":1,"to":2},{"pid":"pid1","from":33,"to":40},{"pid":"pid2","from":22,"to":43},{"pid":"pid2","from":44,"to":60},{"pid":"pid3","from":80,"to":96}]';
    var [dataset,lotMap]=parseJson(str);
    //画布周边的空白
    var padding = {left:40, right:30, top:20, bottom:20};
    var maxt=d3.max(dataset,function(d){
        return d[2];
    });
    var maxp=d3.max(dataset,function(d){
        return d[0];
    });
    console.log(maxt,maxp);
    var linearx=d3.scale.linear()
            .domain([0,maxt])
            .range([0,width-padding.left-padding.right]);
    var lineary=d3.scale.linear()
            .domain([0,maxp])
            .range([0,height - padding.top - padding.bottom]);
    var rectHeight=lineary(2)-lineary(1);
    svg.selectAll("rect")
            .data(dataset)
            .enter()
            .append("rect")
            .attr("x",function(d,i){
                return padding.left+10+linearx(d[1]-1);
            })
            .attr("y",function(d,i){
                return padding.top+lineary(d[0]-1)-0.5*rectHeight;
            })
            .attr("width",function(d){
                return linearx(d[2]-d[1]+1)-2;
            })
            .attr("height",rectHeight-2)
            .attr("fill","steelblue");
    var axisx= d3.svg.axis()
            .scale(linearx)
            .tickFormat(function(d,i){
                return Num2Str(d);
            })
            .orient("bottom")
            .ticks(25);
    var axisy=d3.svg.axis()
            .scale(lineary)
            .tickFormat(function(d,i){
                var id=lotMap[i];
                if(id!=undefined)
                    return id;
                else return "";
            })
            .orient("left")
            .ticks(4);
    svg.append("g")
            .attr("class","axis")
            .attr("transform","translate("+(padding.left+10)+","+(height-padding.bottom)+")")
            .call(axisx);
    svg.append("g")
            .attr("class","axis")
            .attr("transform","translate("+padding.left+","+ padding.top + ")")
            .call(axisy);

</script>
<h1>现状</h1>

</body>
</html>